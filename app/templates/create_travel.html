{% extends "base_search_travels.html" %}
{%block title%}
Buscar Viajes
{%endblock%}
{% block content %}

{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
    {%for category, message in messages%}
        {% if category == "success" %}
        <div id="modal-join-success"  class="myAlert-top alert1 alert-success"style="display: flex;z-index: 1;height: 43px;border-radius: 12px;padding: 9px;width: 29%;margin-top: 1%;margin-bottom: -3%;margin-left: 33%;">
            <strong style="margin-right: 1%; display: flex;"></strong> ¡Viaje creado correctamente! 
            <a href="/usertravelcreate" class="alert-link" style=" margin-left: 1%;"> Ir a mis viajes</a>
        </div>
        {%else%}
        <div id="modal-join-error"  class="myAlert-top alert1 alert-danger" style="display: flex;z-index: 1;height: 43px;border-radius: 12px;padding: 9px;width: 35%;margin-top: 1%;margin-bottom: -3%;margin-left: 33%;">
            <strong style="margin-right: 1%; display: flex;">Error</strong> {{message}}
            </div> 
        {% endif%}
    {% endfor %}
{% endif %}
{%endwith%} 
<div class="search-travel-page">
    <aside class="search-travel-aside">
        <!--<section id=tab-container class="tabs">
            <div id="tablist" role="tablist">
                <button type="button" class="tablink" ><a href="{{url_for('search_travels')}}">Buscar Viajes</a></button>
                <button type="button" class="tablink" disabled="true"> Crear Viajes</button>
            </div>
        </section>!-->
        <section id="search-travel-panel">
            <h3> Creá tu proximo viaje</h1>
            <!--{% with messages = get_flashed_messages() %}
                {% if messages %}
                    <ul class=flashes>
                    {% for message in messages %}
                    <li>{{ message }}</li>
                    {% endfor %}
                    </ul>
                {% endif %}
            {% endwith %}
            {%if error %}
                <p class=error><strong>Error:</strong> {{ error }}
            {% endif %}-->
            <form method="POST" class="search-travel-form">
                {{ form.csrf_token }}
                <div class="form-group">
                    {{ form.origin.label(class="form-control-label") }} 
                    {% if form.origin.errors %}
                        {{ form.origin(class="form-control form-control-lg is-invalid") }}
                        <div class="invalid-feedback">
                            {% for error in form.origin.errors %}
                                <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% else %}
                        {{ form.origin(class="form-control form-control-lg")}}
                    {% endif %}
                </div>
                <div class="form-group">
                    {{ form.destination.label(class="form-control-label") }}
                    {% if form.destination.errors %}
                        {{ form.destination(class="form-control form-control-lg is-invalid") }}
                        <div class="invalid-feedback">
                            {% for error in form.destination.errors %}
                                <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% else %}
                        {{form.destination(class="form-control form-control-lg") }}
                    {% endif %}
                </div>
                <div class="form-group">
                    {{ form.travel_date.label(class="form-control-label") }}
                    {% if form.travel_date.errors %}
                        {{ form.travel_date(class="form-control form-control-lg is-invalid", type="date") }}
                        <div class="invalid-feedback">
                            {% for error in form.travel_date.errors %}
                                <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% else %}
                        {{form.travel_date(class="form-control form-control-lg",type="date") }}
                    {% endif %}
                </div>
                <div class="form-group">
                    {{ form.travel_time.label(class="form-control-label") }}
                    {% if form.travel_time.errors %}
                        {{ form.travel_time(class="form-control form-control-lg is-invalid", type="time") }}
                        <div class="invalid-feedback">
                            {% for error in form.travel_time.errors %}
                                <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% else %}
                        {{form.travel_time(class="form-control form-control-lg",type="time") }}
                    {% endif %}
                </div>
                <div class="form-group">
                    {{ form.travel_time_f.label(class="form-control-label") }}
                    {% if form.travel_time_f.errors %}
                        {{ form.travel_time_f(class="form-control form-control-lg is-invalid") }}
                        <div class="invalid-feedback">
                            {% for error in form.travel_time_f.errors %}
                                <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% else %}
                        {{form.travel_time_f(class="form-control form-control-lg",type="time") }}
                    {% endif %}
                </div>
                <div class="form-group">
                    {{ form.seats.label(class="form-control-label") }}
                    {% if form.seats.errors %}
                        {{ form.seats(class="form-control form-control-lg is-invalid") }}
                        <div class="invalid-feedback">
                            {% for error in form.seats.errors %}
                                <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% else %}
                        {{form.seats(class="form-control form-control-lg") }}
                    {% endif %}
                </div>    
                {{ form.submit(class="btn") }}
            </form>
        </section>
    </aside>
    <div id="map"></div>
</div>
<section class="hero">
  <footer class="footer">
      <div class="content has-text-centered">
        <p>
          <strong>EcoTravel</strong> by Damian Lacomba / Juan Ignacio Pullaro
          <span class="icon is-small">
            <i class="fa fa-copyright"></i>
          </span>2020</span>
        </p>
      </div>
  </footer>
</section>

<script type="text/javascript">

</script>

<script type="text/javascript">

    // The first parameter are the coordinates of the center of the map
    // The second parameter is the zoom level
    var map = L.map('map').setView([-32.9478683, -60.7210182], 12);
    // {s}, {z}, {x} and {y} are placeholders for map tiles
    // {x} and {y} are the x/y of where you are on the map
    // {z} is the zoom level
    // {s} is the subdomain of cartodb
    var layer = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>'
    });

    // Now add the layer onto the map
    map.addLayer(layer);

    //travels
    {%if travels:%}
        const {travels} = {{ travels| safe}}

        console.log(travels)
        travels.map(travel => {
            const origin = L.marker([travel.origen.lat, travel.origen.lon]).addTo(map);
            const dest = L.marker([travel.destino.lat, travel.destino.lon]).addTo(map);
            const popup = '<div class="popup-map">'+
                '<div class="driver"><img href="'+travel.foto_conductor+'"></img><h3>'+travel.conductor+'</h3></div>' +
                '<p className="stars">'+"★".repeat(travel.rating)+"☆".repeat(5-travel.rating)+'</p>' +
                '<b>Origen:</b>'+ travel.origen.nombre +
                '<br /><b>Destino:</b>'+ travel.destino.nombre +
                '<br /><b>Fecha:</b>'+travel.fecha+
                '<br /><b>Hora salida:</b>'+travel.hora+
                '<br /><b>Hora llegada:</b>'+travel.horafin+
                ' <button className="btn-grad btn-travel">Viajar</button></div>'
            origin.bindPopup(popup).openPopup();
        })
    {% endif %}

    setTimeout(function(){$(".myAlert-top").hide();}, 6000);
</script>

{% endblock%}