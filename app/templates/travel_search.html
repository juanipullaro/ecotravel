{% extends "base_search_travels.html" %}
{%block title%}
Buscar Viajes
{%endblock%}
{% block content %}
<div class="search-travel-page">
    <aside class="search-travel-aside">
        <section id=tab-container class="tabs">
            <div id="tablist" role="tablist">
                <button type="button" class="tablink" disabled="true">Buscar Viajes</button>
                <button type="button" class="tablink"> <a href="{{url_for('create_travel')}}">Crear Viajes</a></button>
            </div>

        </section>
        <section id="search-travel-panel">

            {%if error %}
            <p class=error><strong>Error:</strong> {{ error }}
                {% endif %}
            <form method="POST" class="search-travel-form">
                {{ form.csrf_token }}
                {{ form.origin.label }} {{ form.origin() }}
                {{ form.destination.label }} {{ form.destination() }}
                {{ form.travel_date.label }} {{ form.travel_date(type="date") }}
                {{ form.travel_time.label }} {{ form.travel_time(type="time") }}
                {% if error %}
                {{ form.radius.label}} {{ form.radius(type="range", min=5, max=20, step=5, value=10, list="kms")}}
                <datalist id="kms">
                    <option value=5 label="5 kms"></option>
                    <option value=10 label="10 kms"></option>
                    <option value=15 label="15 kms"></option>
                    <option value=20 label="20 kms"></option>
                </datalist>
                <div class="alert">
                    <button onclick="createAlert()">Crear alerta</button>
                </div>
                {% endif%}
                {{ form.submit(class="btn") }}
            </form>
        </section>
    </aside>
    <div id="map"></div>
</div>
<script>
    const createAlert = () => {
        debugger;
        const origin = document.getElementById("origin").value;
        const dest = document.getElementById("destination").value;
        const travel_date = document.getElementById("travel_date").value;
        const travel_time = document.getElementById("travel_time").value;
        const travel = {
            'origin': origin,
            'dest': dest,
            'travel_date': travel_date,
            'travel_time': travel_time
        };
        fetch('/account/alert/create', {
            method: 'POST', // *GET, POST, PUT, DELETE, etc.
            headers: {
                'Content-Type': 'application/json'
                // 'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: JSON.stringify(travel) // body data type must match "Content-Type" header
        }).then((response) => {
            if (response.status == 200) {
                console.log(response)
            }
            else {
                alert(response.json)
            }
        });

    }
</script>
<script type="text/javascript">

    // The first parameter are the coordinates of the center of the map
    // The second parameter is the zoom level
    var map = L.map('map').setView([-32.9478683, -60.7210182], 12);
    // {s}, {z}, {x} and {y} are placeholders for map tiles
    // {x} and {y} are the x/y of where you are on the map
    // {z} is the zoom level
    // {s} is the subdomain of cartodb
    var layer = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>'
    });

    // Now add the layer onto the map
    map.addLayer(layer);

    const jointravel = (id) => {
        fetch('/unirme/' + id)
            .then(() => {
                console.log("se ha unido satisfactoriamente")
            })
    };
    //travels 
    const { travels } = {{ travels| safe}};
    console.log(travels)
    var myIcon = L.icon({
        iconUrl: "static/slider/coche.png",
        iconSize: [20, 60],
        iconAnchor: [22, 94],
        popupAnchor: [-3, -76],
        shadowSize: [68, 95],
        shadowAnchor: [22, 94]
    });
    travels.map(travel => {
        const origin = L.marker([travel.origen.lat, travel.origen.lon], { icon: myIcon }).addTo(map);
        origin.on('mouseover', function (ev) { ev.target.openPopup(); });
        const popup = '<div class="popup-map">' +
            '<div class="driver"><img src="' + travel.foto_conductor + '"></img><h3>' + travel.conductor + '</h3></div>' +
            '<p class="stars">' + "★".repeat(travel.rating) + "☆".repeat(5 - travel.rating) + '</p>' +
            '<b>Origen:</b>' + travel.origen.nombre +
            '<br /><b>Destino:</b>' + travel.destino.nombre +
            '<br /><b>Fecha:</b>' + travel.fecha +
            '<br /><b>Hora:</b>' + travel.hora +
            '<br /><b>Asientos disponibles:</b>' + travel.asientos_disp +
            `<button class="btn-join-travel" onclick="jointravel(${travel.id})">Unirme al viaje</button></div>`
        origin.bindPopup(popup).openPopup();
    })









</script>

{% endblock%}